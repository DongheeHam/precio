<html>
<head>

	<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
	<script type="text/javascript" src="https://gsl.sysoit.com/class/res/tableExport/libs/FileSaver/FileSaver.min.js"></script>
	<script type="text/javascript" src="./xlsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js" ></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css"/> 
    <script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
    <!-- <script type="text/javascript" src=""></script>
    <script type="text/javascript" src=""></script>
    <script type="text/javascript" src=""></script> -->


   <style>
        td{white-space: nowrap;}
        th{white-space: nowrap;}
        .al-right{text-align: right;}
    </style>
	<title>1</title>
</head>
<body>
    <div class="info">
        시트업로드
    </div>
    <div>
        <div>
            <input type="file"id="excel-file" class="excel-file" name="excel">
        </div>
    </div><hr>
    <!-- <div id="current-container">
        <div>결과 시트 <span class="download-container"></span></div>
        <table id="result-table" border="1"> </table>
    </div> -->
    
    <div id="current-container">
        <div>건별 데이터 
            <button onclick="$('.current-table-con').slideToggle()">접기/펴기</button>
            <span class="download-container"></span>
        </div>
        <div class="current-table-con on">
            <table border="1" id="result-table"> 
                <thead></thead>
                <tbody ></tbody>
            </table>
        </div>
    </div><hr>
    <div id="current-container">
        <div>일별 데이터 
            <button onclick="$('.current-table-con2').slideToggle()">접기/펴기</button>
            <span class="download-container"></span>
        </div>
        <div class="current-table-con2 on">
            <table border="1" id="day-result-table"> 
                <thead></thead>
                <tbody ></tbody>
            </table>
            <!-- <table id="day-result-table" border="1"> </table> -->
        </div>
    </div><hr>
    <div id="current-container">
        <div>판매방식별 데이터 
            <button onclick="$('.current-table-con3').slideToggle()">접기/펴기</button>
            <span class="download-container"></span>
        </div>
        <div class="info">
            * 각 row의 판매수량은 고객의 주문 건수임
        </div>
        <div class="current-table-con3 on">
            <table border="1" id="type-result-table"> 
                <thead></thead>
                <tbody ></tbody>
            </table>
            <!-- <table id="day-result-table" border="1"> </table> -->
        </div>
    </div><hr>
    <div id="current-container">
        <div>상품별 데이터 
            <button onclick="$('.current-table-con4').slideToggle()">접기/펴기</button>
            <span class="download-container"></span>
        </div>
        <div class="info">
            * 쿠팡 버킷돌리의 경우 세트로 판매되고있음. 이 경우 상품별 판매 개수까진 알 수 있지만 기초상품별 마진, 비용정보는 알 수 없음<br>
            * 따라서 쿠팡 버킷돌리의 경우 마진, 비용 데이터는 세트단위로 계산함. (품목명 : [쿠팡 버킷돌리세트])<br>
            * 추가로 기초상품별 판매 개수정보는 별도 row에 표기함 (품목명 : [쿠팡 돌리 개별판매개수])<br>
            * [쿠팡 버킷돌리세트]의 판매수량은 고객 주문 건수임<br>
            * 그외 판매수량은 각 기초상품의 총 출고 수량임<br>
            * 합계의 판매수량은 (쿠팡 버킷돌리세트의 판매 건수) + (그 외 주문건의 각 기초상품 출고개수의 합)임.
        </div>
        <div class="current-table-con4 on">
            <table border="1" id="product-result-table"> 
                <thead></thead>
                <tbody ></tbody>
            </table>
            <!-- <table id="day-result-table" border="1"> </table> -->
        </div>
    </div><hr>
    <script>
        // 한국수출입은행 api키 5gctN1ILEdvWKyo346cEErGbip6it8PU
        // https://www.koreaexim.go.kr/site/program/financial/exchangeJSON?authkey=5gctN1ILEdvWKyo346cEErGbip6it8PU&searchdate=20210102&data=AP01
        // 도큐먼트 : https://www.koreaexim.go.kr/site/program/openapi/openApiView?menuid=001003002002001&apino=2&viewtype=C
        var 환율 = {
            
        }
        $("#excel-file").on("change", function(event){
            event.preventDefault(); // 기본효과를 막음
            
            fileupload(event,"sales");
        });
        var EXCEL_JSON;
        function fileupload(e,store){

            var files = e.target.files; //input file 객체를 가져온다.
            var i,f;
            for (i = 0; i != files.length; ++i) {
                f = files[i];
                var reader = new FileReader(); //FileReader를 생성한다.         
                
                //성공적으로 읽기 동작이 완료된 경우 실행되는 이벤트 핸들러를 설정한다.
                reader.onload = function(e) {
                    var data = e.target.result; //FileReader 결과 데이터(컨텐츠)를 가져온다.
 
                    //바이너리 형태로 엑셀파일을 읽는다.
                    var workbook = XLSX.read(data, {type: 'binary'});
                    
                    //엑셀파일의 시트 정보를 읽어서 JSON 형태로 변환한다.
                    workbook.SheetNames.forEach(function(item, index, array) {
                        EXCEL_JSON = XLSX.utils.sheet_to_json(workbook.Sheets[item]);
                        drowCurrent(EXCEL_JSON,store)
                    });//end. forEach
                }; 
                
                //파일객체를 읽는다. 완료되면 원시 이진 데이터가 문자열로 포함됨.
                reader.readAsBinaryString(f);
            
            }//end. for
        }
        function getDateCnt(){
            var dd={}
            for(var i=0;i<sales_result.length;i++){
                var row=sales_result[i]
                var date=row["주문일자"].substr(0,10)
                if(dd[date]==null){
                    dd[date]=1
                }
            }
            return Object.keys(dd).length;
        }
        function setProductData(){
            var all={
                품목명:"합계",
                기초상품명:"-",
                판매수량:0,
                결제금액:0,
                정산금액:0,
                원가:0,
                원가율:0,
                출고비용:0,
                마진금액:0,
                마진율:0,
                마진비중률:0,
            }
            for(var i=0;i<sales_result.length;i++) {
                var row=sales_result[i];
                if(row["업체상품코드"]=="12978387331"){// 쿠팡 버킷돌리 세트
                    console.log("row:",row)
                    var base=row["기초상품명"].split(',');
                    
                    for(var j=0;j<base.length;j++){
                        var cp기초상품명="[쿠팡 버킷돌리세트] : "+base[j];
                        var cp판매수량=row["수량"]*Number((""+row["건별출고수량"]).split(',')[j]);
                        if(product_data[cp기초상품명]==null){
                            product_data[cp기초상품명]={
                                품목명:"[쿠팡 돌리 개별판매개수]",
                                기초상품명:cp기초상품명,
                                판매수량:cp판매수량,
                                결제금액:"-",
                                정산금액:"-",
                                원가:"-",
                                원가율:"-",
                                출고비용:"-",
                                마진금액:"-",
                                마진율:"-",
                                마진비중률:"-",
                            }
                        }else{
                            product_data[cp기초상품명].판매수량+=cp판매수량
                        }
                    }
                    if(product_data["[쿠팡 버킷돌리세트]"]==null){
                        product_data["[쿠팡 버킷돌리세트]"]={
                            품목명:"[쿠팡 버킷돌리세트]",
                            기초상품명:"[쿠팡 버킷돌리세트]",
                            판매수량:row["수량"],
                            결제금액:row["상품결제금액"]+row["고객결제배송비"],
                            정산금액:row["정산금액"]+row["배송비정산금액"],
                            원가:row["원가"],
                            원가율:0,
                            출고비용:row["출고비용"]+row["국제배송비"],
                            마진금액:row["수익금"],
                            마진율:0,
                            마진비중률:0,
                        }
                    }else{
                        product_data["[쿠팡 버킷돌리세트]"].판매수량+=row["수량"];
                        product_data["[쿠팡 버킷돌리세트]"].결제금액+=row["상품결제금액"]+row["고객결제배송비"];
                        product_data["[쿠팡 버킷돌리세트]"].정산금액+=row["정산금액"]+row["배송비정산금액"];
                        product_data["[쿠팡 버킷돌리세트]"].원가+=row["원가"];
                        product_data["[쿠팡 버킷돌리세트]"].출고비용+=row["출고비용"]+row["국제배송비"];
                        product_data["[쿠팡 버킷돌리세트]"].마진금액+=row["수익금"];
                    }
                    // all 작업
                    all.판매수량+=row["수량"];
                }else{
                    var option=row["기초상품명"]
                    if(product_data[option]==null){
                        product_data[option]={
                            품목명:row["품목"],
                            기초상품명:row["기초상품명"],
                            판매수량:0,
                            결제금액:0,
                            정산금액:0,
                            원가:0,
                            원가율:0,
                            출고비용:0,
                            마진금액:0,
                            마진율:0,
                            마진비중률:0,
                        }
                    }
                    product_data[option].판매수량+=row["건별출고수량"]*row["수량"];
                    product_data[option].결제금액+=row["상품결제금액"]+row["고객결제배송비"];
                    product_data[option].정산금액+=row["정산금액"]+row["배송비정산금액"]
                    product_data[option].원가+=row["원가"];
                    product_data[option].출고비용+=row["출고비용"]+row["국제배송비"];
                    product_data[option].마진금액+=row["수익금"];

                    // all 작업
                    all.판매수량+=row["건별출고수량"]*row["수량"];
                }
//                 if("2004062089"==row["쇼핑몰상품코드"])console.log(`
// ==========================================================
// [${row["품목"]}:${row["옵션"]}]
//     정산금액:${row["정산금액"]}
//     배송비정산금액:${row["배송비정산금액"]}
//     수익금:${row["수익금"]}
//     원가:${row["원가"]}
//     출고비용:${row["출고비용"]}
//     국제배송비:${row["국제배송비"]}
//                 `)
                all.결제금액+=row["상품결제금액"]+row["고객결제배송비"];
                all.정산금액+=row["정산금액"]+row["배송비정산금액"]
                all.원가+=row["원가"];
                all.출고비용+=row["출고비용"]+row["국제배송비"];
                all.마진금액+=row["수익금"];

            }
            
            console.log("all.마진금액:",all.마진금액);
            for(var i=0;i<Object.keys(product_data).length;i++){
                var row=product_data[Object.keys(product_data)[i]];
                row.원가율=Number((row.원가/row.결제금액*100).toFixed(2));
                row.마진율=Number((row.마진금액/row.결제금액*100).toFixed(2));
                row.마진비중률=Number((row.마진금액/all.마진금액*100).toFixed(2));
                product_data_list.push(row);
            }

            // 합계작업
            all.원가율=Number((all.원가/all.결제금액*100).toFixed(2));
            all.마진율=Number((all.마진금액/all.결제금액*100).toFixed(2));
            all.마진비중률=Number((all.마진금액/all.마진금액*100).toFixed(2));
            product_data_list.push(all);
        }
        function setTypeData(){
            var ddCnt=getDateCnt();

            var all={조회기간 : ddCnt+"일",
                        type : "합계",
                        판매수량:0,
                        정산금액:0,
                        지출금액:0,
                        수익금액:0,}
            for(var i=0;i<sales_result.length;i++) {
                var row=sales_result[i];
                var type=row["타입"];
                if(type_data[type]==null){
                    type_data[type]={
                        조회기간 : ddCnt+"일",
                        type : type,
                        판매수량:0,
                        정산금액:0,
                        지출금액:0,
                        수익금액:0,
                    }
                }
//                 if("2004062089"==row["쇼핑몰상품코드"])console.log(`
// ==========================================================
// [${row["품목"]}:${row["옵션"]}]
//     정산금액:${row["정산금액"]}
//     배송비정산금액:${row["배송비정산금액"]}
//     수익금:${row["수익금"]}
//     원가:${row["원가"]}
//     출고비용:${row["출고비용"]}
//     국제배송비:${row["국제배송비"]}
//                 `)
                type_data[type].판매수량+=1;
                type_data[type].정산금액+=row["정산금액"]+row["배송비정산금액"];
                type_data[type].지출금액+=row["원가"]+row["출고비용"]+row["국제배송비"];
                type_data[type].수익금액+=row["수익금"];

                all.판매수량+=1;
                all.정산금액+=row["정산금액"]+row["배송비정산금액"];
                all.지출금액+=row["원가"]+row["출고비용"]+row["국제배송비"];
                all.수익금액+=row["수익금"];
            }
            for(var i=0;i<Object.keys(type_data).length;i++){
                var row=type_data[Object.keys(type_data)[i]];
                row.순수익율=Number((row.수익금액/row.정산금액*100).toFixed(2));
                type_data_list.push(row);
            }
            all.순수익율=Number((all.수익금액/all.정산금액*100).toFixed(2));
            type_data_list.push(all);
        }
        function setOrderData(){
            for(var i=0;i<sales_result.length;i++){
                // 1. 구매대행 원가/ 출고비용 계산 (사입은 이미했음)
                var row=sales_result[i]
                if(mallProductCode[row["품목"]].type=="구매대행"){
                    var date=row["발주일자"].substr(0,8)

                    var 원가=0;
                    if(row["해외화폐(위안)"]!=0){
                        // row["bkpr"]=(Number(환율[date].cnh.bkpr.replace(/[^\d.]/g, ''))*row["해외화폐(위안)"]).toFixed(2);
                        // row["deal_bas_r"]=(Number(환율[date].cnh.deal_bas_r.replace(/[^\d.]/g, ''))*row["해외화폐(위안)"]).toFixed(2);
                        // row["kftc_bkpr"]=(Number(환율[date].cnh.kftc_bkpr.replace(/[^\d.]/g, ''))*row["해외화폐(위안)"]).toFixed(2);
                        // row["kftc_deal_bas_r"]=(Number(환율[date].cnh.kftc_deal_bas_r.replace(/[^\d.]/g, ''))*row["해외화폐(위안)"]).toFixed(2);
                        // row["ttb"]=(Number(환율[date].cnh.ttb.replace(/[^\d.]/g, ''))*row["해외화폐(위안)"]).toFixed(2);
                        // row["tts"]=(Number(환율[date].cnh.tts.replace(/[^\d.]/g, ''))*row["해외화폐(위안)"]).toFixed(2);
                        원가+=Math.round(Number(환율[date].cnh.tts.replace(/[^\d.]/g, ''))*row["해외화폐(위안)"]);
                    }else if(row["해외화폐(달러)"]!=0){
                        // row["bkpr"]=(Number(환율[date].usd.bkpr.replace(/[^\d.]/g, ''))*row["해외화폐(달러)"]).toFixed(2);
                        // row["deal_bas_r"]=(Number(환율[date].usd.deal_bas_r.replace(/[^\d.]/g, ''))*row["해외화폐(달러)"]).toFixed(2);
                        // row["kftc_bkpr"]=(Number(환율[date].usd.kftc_bkpr.replace(/[^\d.]/g, ''))*row["해외화폐(달러)"]).toFixed(2);
                        // row["kftc_deal_bas_r"]=(Number(환율[date].usd.kftc_deal_bas_r.replace(/[^\d.]/g, ''))*row["해외화폐(달러)"]).toFixed(2);
                        // row["ttb"]=(Number(환율[date].usd.ttb.replace(/[^\d.]/g, ''))*row["해외화폐(달러)"]).toFixed(2);
                        // row["tts"]=(Number(환율[date].usd.tts.replace(/[^\d.]/g, ''))*row["해외화폐(달러)"]).toFixed(2);
                        원가+=Math.round(Number(환율[date].usd.tts.replace(/[^\d.]/g, ''))*row["해외화폐(달러)"]);
                    }
                    console.log("구매대행 row:",row)
                    row["원가"]=원가
                }

                // 2. 수익금 계산
                row["수익금"]=row["정산금액"]+row["배송비정산금액"]-row["원가"]-row["출고비용"]-row["국제배송비"]
            }
        }
        function setDayData(){
            // 3. 일일 수익금 계산
            for(var i=0;i<sales_result.length;i++) {
                var row=sales_result[i];
                var date=row["주문일자"].substr(0,10)
                if(date_data[date]==null){
                    date_data[date]={
                        date:date,
                        스토어결제금액:0,
                        정산금액:0,
                        고객결제배송비:0,
                        배송비정산금액:0,
                        사입_원가:0,
                        사입_출고비용:0,
                        사입_수익금:0,
                        구매대행_구매금액:0,
                        구매대행_국제배송비:0,
                        구매대행_수익금:0,
                        일매출:0,
                        일순이익:0,
                    }
                }
                if("2004062089"==row["쇼핑몰상품코드"])console.log(`
// ==========================================================
// [${row["품목"]}:${row["옵션"]}]
//     상품결제금액:${row["상품결제금액"]}
//     정산금액:${row["정산금액"]}
//     고객결제배송비:${row["고객결제배송비"]}
//     배송비정산금액:${row["배송비정산금액"]}
//     수익금:${row["수익금"]}
//     원가:${row["원가"]}
//     출고비용:${row["출고비용"]}
//     수익금:${row["수익금"]}
//     국제배송비:${row["국제배송비"]}
//                 `)
                date_data[date].스토어결제금액+=row["상품결제금액"];
                date_data[date].정산금액+=row["정산금액"];
                date_data[date].고객결제배송비+=row["고객결제배송비"];
                date_data[date].배송비정산금액+=row["배송비정산금액"];
                if(mallProductCode[row["품목"]].type!="구매대행"){
                    date_data[date].사입_원가+=row["원가"];
                    date_data[date].사입_출고비용+=row["출고비용"];
                    date_data[date].사입_수익금+=row["수익금"];
                }else{
                    date_data[date].구매대행_구매금액+=row["원가"];
                    date_data[date].구매대행_국제배송비+=row["국제배송비"];
                    date_data[date].구매대행_수익금+=row["수익금"];
                }
                date_data[date].일매출+=row["상품결제금액"]+row["고객결제배송비"];
                date_data[date].일순이익+=row["수익금"];
//                 console.log(`
//     date_data[${date}].스토어결제금액:${date_data[date].스토어결제금액}
//     date_data[${date}].정산금액:${date_data[date].정산금액}
//     date_data[${date}].고객결제배송비:${date_data[date].고객결제배송비}
//     date_data[${date}].배송비정산금액:${date_data[date].배송비정산금액}
//     date_data[${date}].사입_원가:${date_data[date].사입_원가}
//     date_data[${date}].사입_출고비용:${date_data[date].사입_출고비용}
//     date_data[${date}].사입_수익금:${date_data[date].사입_수익금}
//     date_data[${date}].구매대행_구매금액:${date_data[date].구매대행_구매금액}
//     date_data[${date}].구매대행_국제배송비:${date_data[date].구매대행_국제배송비}
//     date_data[${date}].구매대행_수익금:${date_data[date].구매대행_수익금}
//     date_data[${date}].일순이익:${date_data[date].일순이익}
// ==========================================================
//                 `)
            }
            for(var i=0;i<Object.keys(date_data).length;i++){
                var row=date_data[Object.keys(date_data)[i]];
                row.일마진=Number((row.일순이익/row.일매출*100).toFixed(2));
                date_data_list.push(row);
            }
        }
        function drowCurrent(json,store){
            console.log("drowCurrent json:",json)
            default_data

            // current 그리기
            buildHtmlTable(store+"-current-table",json,true);

            // result data 생성
            addResult(json,store);

            // result 그리기
            getExchange(0,function(){
                // 불필요한 환율 버리기
                for(var i=0;i<Object.keys(환율).length;i++){
                    var row=환율[Object.keys(환율)[i]];
                    var temp={}
                    for(var j=0;j<row.length;j++){
                        if(row[j].cur_unit=="USD")temp.usd=row[j]
                        if(row[j].cur_unit=="CNH")temp.cnh=row[j]
                        if(temp.usd!=null && temp.chn!=null){
                            break;
                        }
                    }
                    console.log(`환율[${Object.keys(환율)[i]}] : `,row);
                    console.log(`temp : `,temp);
                    환율[Object.keys(환율)[i]]=temp;
                }
                
            	setOrderData();

                setDayData();

                setTypeData();

                setProductData();

                buildHtmlTable("result-table",sales_result,true);
               buildHtmlTable("day-result-table",date_data_list,true);
               buildHtmlTable("type-result-table",type_data_list,true);
               buildHtmlTable("product-result-table",product_data_list,true);
            })
        }
        function setExchange(dateString,cb){
        	if(환율[dateString]!=null&& 환율[dateString].length!=0){
        		cb();
        	}else{
            	$.post('https://www.koreaexim.go.kr/site/program/financial/exchangeJSON',
                        {authkey:"5gctN1ILEdvWKyo346cEErGbip6it8PU",searchdate : dateString,data:"AP01"},
                        function(res){
                        	if(res.length==0){
                        		setWeekendExchange(dateString,function(){
                        			 cb();
                        		})
                        	}else{
	                        	 환율[dateString]=res;
	                           	 cb();
                        	}
                    }).fail(function(r,r2,r3){
                        if(r2=="error") alert("환율정보를 받아오는데 실패했습니다. CORS설정을 확인하세요.")
                    })
        	}
        }
        // []인 경우 사용. dateString의 전날데이터를  dateString에 붙임, 전날이 null이면 구해서붙임
        function setWeekendExchange(dateString,cb){
        	var yesterday=moment(dateString).add(-1,'d').format('YYYYMMDD');
        	
        	if(환율[yesterday]==null){
        		setExchange(yesterday,function(){
        			환율[dateString]=환율[yesterday]
        			cb()
        		})
        	}else{
        		if(환율[yesterday].length==0){
        			setWeekendExchange(yesterday,function(){
        				환율[dateString]=환율[yesterday]
        				cb();
        			})
        		}else{
        			환율[dateString]=환율[yesterday]
            		cb()
        		}
        	}
        }
        function getExchange(i,cb){
        	if(i>=sales_result.length-1){
        		console.log("setDateDate end");
        		cb();
        	}else{
        		var row=sales_result[i]
				if(row.발주일자!=null&& row.발주일자!=""){
					var d=row.발주일자.substr(0,8)
	                // 해당 발주일의 환율값이 없다면 가져다놓기
	                var date=moment(d).format('YYYYMMDD')
	                console.log("d:",d,"\ndate:",date);
	                if(date!="Invalid date"&& 환율[date]==null){
	                	setExchange(date,function(res){
         					getExchange(++i,cb)
	                	});
	                 	
	                 }else{
	 					getExchange(++i,cb)
	                	 
	                 }
				}else{
					getExchange(++i,cb)
				}
        	}
        }
var default_data;
sales_result=[] // 건별데이터(총괄데이터)
product_data={} // 상품별 데이터 작업용
product_data_list=[] // 상품별 데이터
type_data={} // 판매방식별 데이터 작업용
type_data_list=[] //판매방식별 데이터
date_data_list=[] // 일자별데이터
date_data={} // 일자별 데이터 작업용
bundle_order={} // 고객이 내 스토어에서 주문한 주문의 묶음번호
invalidMemo=[]
발주번호={} // 구매대행 결제한 해외 주문번호
function addResult(json,store){console.log(json,store)
    for (var i = 0 ; i < json.length ; i++) {
        var row=json[i];
        // console.log("bundle_order[row[묶음번호]]",bundle_order[row["묶음번호"]])
        // console.log("row[묶음번호]",row["묶음번호"])
        if(bundle_order[row["묶음번호"]]==null){
            bundle_order[row["묶음번호"]]=[]
        }
        bundle_order[row["묶음번호"]].push(row);
    }
    for (var i = 0 ; i < json.length ; i++) {
        var row=json[i];
        console.log("row:",row)
        
        // 취소 환불건 처리
        if(
            row["주문상태"]=="주문재확인" ||
            row["주문상태"]=="반품완료" ||
            row["주문상태"]=="취소완료" 
        )continue;

        // => 주문수량 0인경우 건너뛰기
        if(row["주문수량"]==0) continue;
        
        var newRow={
            "쇼핑몰상품코드":row["쇼핑몰상품코드"],
            "주문플랫폼":row["쇼핑몰"],
            "주문일자":row["결제완료일"],
            "국내오더넘버":row["쇼핑몰주문번호"],
            "업체상품코드":row["쇼핑몰상품코드"],
            "품목":"", //밑에서 채움
            "옵션":row["옵션"],
            "수량":row["주문수량"],
            "타입":"",
            "기초상품명":row["기초상품명"],
            "건별출고수량":row["건별출고수량"],
            "구매자":row["주문자명"],
            "상품결제금액":row["금액"],
            "고객결제배송비":0,
            "정산금액":0,
            "배송비정산금액":0,
            "출고비용":0,
            "원가":row["원가"],
            "수익금":0,
            "발주일자":"",
            "해외구매처":row["매입처"],
            "해외오더넘버":"",
            "배송대행지":"",
            "국제배송비":0,
            "일괄발주여부":"",
            "해외화폐(달러)":0,
            "해외화폐(위안)":0,
        }

        // 상품명 간략화 처리
        var productName=findProductName(row["쇼핑몰상품코드"]);

if(productName==null){
    alert(`상품목록데이터에 등록되지 않은 상품의 주문이 있습니다. 상품정보를 최신화해주세요.
주문처 : ${row["쇼핑몰"]}
상품명 : ${row["온라인상품명"]}
상품번호 : ${row["쇼핑몰상품코드"]}`)
    return;
}
if(row["기초상품명"]==null||row["기초상품명"]==""){
    alert(`솔루션의 기초상품이 매칭되지 않은 주문건이 있습니다. 기초상품을 매칭하고 다시 시도해주세요.
주문처 : ${row["쇼핑몰"]}
상품명 : ${row["온라인상품명"]}
옵션 : ${row["옵션"]}
상품번호 : ${row["쇼핑몰상품코드"]}`)
    return;
}
        newRow["품목"]=productName;
        newRow["타입"]=mallProductCode[productName].type;
        
        // 정산 금액 계산
        if(row["쇼핑몰"]=="스마트스토어"||row["쇼핑몰"]=="지마켓"){
            newRow["정산금액"]=row["공급가"];
        }else{
            var fee=getProductFee(row["쇼핑몰상품코드"],row["쇼핑몰"]);
            console.log("fee:",fee);
            var pay=Number(row["금액"]);
            newRow["정산금액"]=Math.floor(pay-(pay*fee/100));
        }

        // 고객결제배송비 묶음별로 1개로 처리 
        // 기존 버전
        // if(bundle_order[row["묶음번호"]]==null){
        //     newRow["고객결제배송비"]=row["배송비"];
        // }else{
        //     newRow["고객결제배송비"]=0
        // }
        // 3안 버전
        newRow["고객결제배송비"]=Math.round(row["배송비"]/bundle_order[row["묶음번호"]].length)
        newRow["배송비정산금액"]=Math.round(newRow["고객결제배송비"]*0.967)


        // 메모 => 구매대행정보 변환

        var memo=row["메모"];
        console.log("memo:"+memo);
        var memoS=memo.split("/");
        
        // 발주 안한 구매대행있으면 넘어가기
        if(newRow["타입"]=="구매대행" && memoS.length!=3){
            invalidMemo.push(row)
            continue;
        }
        
        if(memoS.length!=3){ // 사입
            /* var 해외오더넘버=memo;
            newRow["해외오더넘버"]=해외오더넘버;
            invalidMemo.push({current:i,result:sales_result.length}); */
        	
            // 버킷돌리 네이버 추가옵션도 같은 버킷돌리로 인식함. 따라서 기초상품을 등록하거나 묶음상품을 하나로 인식하도록 처리해야지 출고비용을 계산할 수 있음
            // 기존 버전
            // if(bundle_order[row["묶음번호"]]==null){
            //     newRow["출고비용"]=mallProductCode[productName].출고비용
            // }else{
            //     newRow["출고비용"]=0
            // }
            // 3안 버전
            newRow["출고비용"]=Math.round(mallProductCode[productName].출고비용/bundle_order[row["묶음번호"]].length)
        }else{ // 구매대행
            var 해외오더넘버=memoS[0].trim();
            var 발주일자=memoS[1].trim(); //YYYYMMDDHHmm
            발주일자=발주일자.replace(/[^\d.]/g, '');
            var 구매금액=Number(memoS[2].trim());

            newRow["발주일자"]=발주일자;
            newRow["해외오더넘버"]=해외오더넘버;
            newRow["배송대행지"]=getShippingAgency(row["매입처"]);

            

            // 달러면 달러컬럼에, 위안화면 위안화컬럼에 추가
            var paymentCurrency=getPaymentCurrency(row["매입처"]);
            if(paymentCurrency=="달러"){
                newRow["해외화폐(달러)"]=구매금액;
            }else if(paymentCurrency=="위안"){
                newRow["해외화폐(위안)"]=Number((구매금액*1.03).toFixed(2));
            }

            // 동일주문 체크를 위한 발주번호 키 정리
            if(발주번호[해외오더넘버]!=null){
                newRow["일괄발주여부"]="일괄발주";
                발주번호[해외오더넘버].push(sales_result.length)
                newRow["해외화폐(위안)"]=0
                newRow["해외화폐(달러)"]=0
                newRow["국제배송비"]=0;

                sales_result[발주번호[해외오더넘버][0]]["일괄발주여부"]="일괄발주";
            }else{
                발주번호[해외오더넘버]=[sales_result.length]
            }

            // 국제배송비
            if(productName=="전기종 짱구케이스" || productName=="A시리즈 짱구케이스"){
                // 기존 버전
                // if(bundle_order[row["묶음번호"]]==null){
                //     newRow["국제배송비"]=4500
                // }else{
                //     newRow["국제배송비"]=0
                // }
                // 3안 버전
                newRow["국제배송비"]=Math.round(4500/bundle_order[row["묶음번호"]].length)
            }
        }
        
        console.log("newRow:",newRow)
        sales_result.push(newRow);
    }

    // 발주번호 미중복 주문건 삭제 (일괄결제건만 남기고 삭제)
    // 모든 키 정리표로 쓸 수도 있으니 안하는게 나을듯
    // for(var i=0;i>Object.keys(발주번호).length;i++){
    //     var Object.keys(발주번호)
    // }


    // 메모이상건 있으면 alert
    if(invalidMemo.length!=0){
        var msg="메모가 형식에 맞지 않는 구매대행 주문건이 있습니다. 제외하고 처리되었습니다. \n\n";
        for(var i=0;i<invalidMemo.length;i++){
            msg+=`======================================
주문처 : ${row["쇼핑몰"]}
주문일:${invalidMemo[i].결제완료일}
상품명:${invalidMemo[i].온라인상품명}
주문자명:${invalidMemo[i].주문자명}
메모내용:${invalidMemo[i].메모}
`
        }
        alert(msg);
    }

    //$('.download-container').html('<button onclick="download()">결과시트 다운로드</button>')
}

// Builds the HTML Table out of myList json data from Ivy restful service.
 function buildHtmlTable(id,json,isDrowHeader) {
     var columns = addAllColumnHeaders(id,json,isDrowHeader);
     var percent=["마진율","마진비중률","원가율","순수익율","일마진"];
     for (var i = 0 ; i < json.length ; i++) {
         var row$ = $('<tr/>');
         for (var colIndex = 0 ; colIndex < columns.length ; colIndex++) {
             var cellValue = json[i][columns[colIndex]];
             if (cellValue == null) { cellValue = ""; }
             var td=$('<td/>').html(cellValue);
            if(typeof cellValue=="number"){
             td.addClass("al-right");
             td.html(td.html().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g,","))
            }
            if(percent.indexOf(columns[colIndex])!=-1){
                td.html(td.html()+'%')
            }

             row$.append(td);
         }
         $("#"+id+" tbody").append(row$);
     }
     $('#'+id).DataTable({
        "aLengthMenu": [[25, 50, 75, -1], [25, 50, 75, "All"]],
        "iDisplayLength": -1,
        dom: 'Bfrtip',
        "buttons": [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ]
    });
 }

 
 // Adds a header row to the table and returns the set of columns.
 // Need to do union of keys from all records as some records may not contain
 // all records
 function addAllColumnHeaders(id,json,isDrowHeader)
 {
     
     var columnSet = [];
     var headerTr$ = $('<tr/>');
 
     for (var i = 0 ; i < json.length ; i++) {
         var rowHash = json[i];
         for (var key in rowHash) {
             if ($.inArray(key, columnSet) == -1){
                 columnSet.push(key);
                 isDrowHeader && headerTr$.append($('<th/>').html(key));
             }
         }
     }
     isDrowHeader && $("#"+id+" thead").append(headerTr$);
     //console.log("columnSet:",columnSet)
     return columnSet;
 }
 function download(tp){
    // var workSheet;
    // var filename;
    // var wb = XLSX.utils.book_new();
    // if(tp=="on"){
    //     workSheet = XLSX.utils.json_to_sheet(on_result);
    //     filename=moment().format('YYYY-MM-DD 온채널주문서');
    //     XLSX.utils.book_append_sheet(wb, workSheet, 'sheet1');
    //     XLSX.writeFile(wb, filename+'.xls');
    // }else if(tp=="my"){
    //     workSheet = XLSX.utils.json_to_sheet(my_result);
    //     filename=moment().format('프레시오_YYYYMMDD');
    //     XLSX.utils.book_append_sheet(wb, workSheet, 'sheet1');
    //     XLSX.writeFile(wb, filename+'.xls');
    // }
    var workbook = new ExcelJS.Workbook();
    var atcAoaData=[];
    var atcSheet =  workbook.addWorksheet('결과시트', {
		pageSetup:{
			paperSize: 9, 
			orientation:'landscape',
			horizontalCentered:true,
			verticalCentered:true,
			fitToPage:true
		},
		headerFooter:{firstHeader: '결과시트'},
	});

    var header=Object.keys(sales_result[0]);

    atcAoaData.push(header);

    for(var i=0;i<sales_result.length;i++){
        var row=[]
        for(var j=0;j<header.length;j++){
            row.push(sales_result[i][header[j]]);
        }
        console.log("row:",row);
        atcAoaData.push(row);
    }
    atcSheet.addRows(atcAoaData);

    // 글씨크기 변경
    for (var i = 1; i <= atcSheet.actualRowCount; i++) {
        for (var j = 1; j <= atcSheet.actualColumnCount; j++) {
            atcSheet.getRow(i).getCell(j).font= {
                    size:8,
                };
        }
        console.log()
    }

    lastColor="FF00FF00"
    for(var i=0;i<Object.keys(발주번호).length;i++){
        var mergeList=발주번호[Object.keys(발주번호)[i]]
        console.log("mergeList:",mergeList)
        if(mergeList.length>1){

            //atcSheet.mergeCells(mergeList[0]+2, 27,mergeList[mergeList.length-1]+2,27);
            var fontcolor;
            if(lastColor=="FF00FF00") fontcolor="FF0000FF"
            else fontcolor="FF00FF00"
            lastColor=fontcolor
            for(var j=0;j<mergeList.length;j++){
                atcSheet.getRow(mergeList[j]+2).getCell(27).font= {
                    color: { argb: fontcolor},
                };
            }
        }
    }

    workbook.xlsx.writeBuffer()
    .then(function(buffer){saveAs$$module$FileSaver(new Blob([buffer]), "결과시트" + (new Date()).toISOString().substring(0,10)+".xlsx")})
	.catch(function(err){console.log('Error writing excel export', err)})

 }
 function s2ab(s) {
    var buf = new ArrayBuffer(s.length);
    var view = new Uint8Array(buf);
    for ( var i=0; i != s.length; ++i ) view[ i ] = s.charCodeAt( i ) & 0xFF;
    return buf;
  }
  
// const mallProductCode={
//     "N 도어잠금커버":['12828779715','5783006936'],
//     "N 목쿠션":["12828779717",'5785531103'],
//     "N LED컵홀더":["12828779717",'5808226980'],
//     "N 벨트커버":["12828779727","5781215842"],
//     "N 가죽키링":["12828779759","5785677012"],
//     "N 가죽각인키링":["5785656301"],
//     "N 고리형 키링":["5786280114"],
//     "N 도어라이트":["12828779813","5788371143"],
//     "N 앞유리스티커":["5781154026"],
//     "N 무릎쿠션":["5783126882"],
//     "N 헤드레스트":["5783893434"],

//     "전기종 짱구케이스":["12828781583","5804499491"],
//     "A시리즈 짱구케이스":["12828779807","5804576431"],
//     "짱구스티커":["5839914887"],

//     "버킷돌리":['2331466628','6043141454','8839868375'],
//     "버킷돌리(세트)":['12978387331'],
//     "버킷돌리(추가상품)":["6131658967"],
//     "악력기":["13021910128"],
// }
const mallProductCode={
    "N 쓰레기통":{
        product:['5850067258','12832628039'],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N 도어잠금커버":{
        product:['12828779715','5783006936'],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N 목쿠션":{
        product:["12828779717",'5785531103'],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N LED컵홀더":{
        product:["12828779720",'5808226980'],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N 벨트커버":{
        product:["12828779727","5781215842"],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N 가죽키링":{
        product:["12828779759","5785677012"],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N 가죽각인키링":{
        product:["5785656301","12828779759"],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N 고리형 키링":{
        product:["5786280114","12828779785"],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N 도어라이트":{
        product:["12828779813","5788371143"],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N 앞유리스티커":{
        product:["5781154026","12829011126"],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N 무릎쿠션":{
        product:["5783126882","12828779812"],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },
    "N 헤드레스트":{
        product:["5783893434","12828779718"],
        fee:{
            "쿠팡":11,
        },
        type:"구매대행"
    },

    "전기종 짱구케이스":{
        product:["12828781583","5804499491"],
        fee:{
            "쿠팡":8.6,
        },
        type:"구매대행"
    },
    "A시리즈 짱구케이스":{
        product:["12828779807","5804576431"],
        fee:{
            "쿠팡":8.6,
        },
        type:"구매대행"
    },
    "짱구스티커":{
        product:["5839914887"],
        fee:{
            "쿠팡":11,
        },
        type:"사입",
        	출고비용:2300
    },

    "버킷돌리":{
        product:['2331466628','6043141454','8839868375','2004062089','139370885','4080302072'],
        fee:{
            "쿠팡":11,
            "11번가":13,
            "티몬":14,
            "위메프2.0":13,
            "지마켓":13,
            "옥션":13,
            "인터파크":13,
            "롯데ON":13,
            "카카오톡 스토어":6.6,
        },
        type:"사입",
    	출고비용:4400
    },
    "버킷돌리(세트)":{
        product:['12978387331'],
        fee:{
            "쿠팡":11,
            "11번가":13,
            "티몬":14,
            "위메프2.0":13,
            "지마켓":13,
            "옥션":13,
            "인터파크":13,
            "롯데ON":13,
        },
        type:"사입",
    	출고비용:4400
    },
    "버킷돌리(추가상품)":{
        product:["6131658967"],
        fee:{
            "쿠팡":11,
            "11번가":13,
            "티몬":14,
            "위메프2.0":13,
            "지마켓":13,
            "옥션":13,
            "인터파크":13,
            "롯데ON":13,
        },
        type:"사입",
    	출고비용:3400
    },
    "악력기":{
        product:["13021910128"],
        fee:{
            "쿠팡":11.9,
        },
        type:"위탁판매",
    	출고비용:2800
    },
}

// 결제화페 수단
function getPaymentCurrency(해외구매처){
    if(해외구매처=="알리익스프레스"){
        return "달러";
    }else if(해외구매처=="타오바오"){
        return "위안";
    }else{
        return null;
    }
}

// 배송대행지
function getShippingAgency(해외구매처){
    if(해외구매처=="알리익스프레스"){
        return "-";
    }else if(해외구매처=="타오바오"){
        return "토스토스";
    }else{
        return null;
    }
}

// 상품명
function findProductName(code){
    for(var i=0;i<Object.keys(mallProductCode).length;i++){
        var p=mallProductCode[Object.keys(mallProductCode)[i]]
        for(var j=0;j<p.product.length;j++){
            if(code==p.product[j]){
                return Object.keys(mallProductCode)[i]
            }
        }
    }
    return null;
}

// 수수료
function getProductFee(code,store){
    for(var i=0;i<Object.keys(mallProductCode).length;i++){
        var p=mallProductCode[Object.keys(mallProductCode)[i]]
        for(var j=0;j<p.product.length;j++){
            if(code==p.product[j]){
                return mallProductCode[Object.keys(mallProductCode)[i]].fee[store]
            }
        }
    }
    return 13;
}

// 판매구분
function getProductType(code){
    for(var i=0;i<Object.keys(mallProductCode).length;i++){
        var p=mallProductCode[Object.keys(mallProductCode)[i]]
        for(var j=0;j<p.product.length;j++){
            if(code==p.product[j]){
                return mallProductCode[Object.keys(mallProductCode)[i]].type
            }
        }
    }
    return 13;
}
    </script>
</body>
</html>
